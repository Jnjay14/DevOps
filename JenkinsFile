pipeline {
    agent any

    environment {
        LOG_DIR = "/tmp/newsflow-logs"
    }

    stages {
        stage('init') {
            steps {
                // 2. Environment check: ensure Python 3 is available
                sh 'python3 --version'

                // Create timestamp for versioned filenames
                script {
                    env.TIMESTAMP = sh(
                        script: 'date +%Y%m%d%H%M%S',
                        returnStdout: true
                    ).trim()
                }

                // Ensure log directory exists
                sh "mkdir -p ${LOG_DIR}"
            }
        }

        stage('test') {
            steps {
                // 3. Run unittest and save output to timestamped log in /tmp/newsflow-logs
                sh """
                    python3 -m unittest -v test_parse_articles.py \
                    | tee ${LOG_DIR}/unittest-${env.TIMESTAMP}.log
                """
            }
        }

        stage('verify') {
            steps {
                script {
                    // Run grep but capture exit status explicitly
                    int status = sh(
                        script: "grep -q 'OK' ${LOG_DIR}/unittest-${env.TIMESTAMP}.log",
                        returnStatus: true
                    )

                    if (status != 0) {
                        // Fail pipeline with a clear message
                        error "Tests did NOT finish with OK. Check log: ${LOG_DIR}/unittest-${env.TIMESTAMP}.log"
                    }
                }
            }
        }

        stage('archive') {
            steps {
                // 4. Copy log into workspace (so Jenkins can archive it)
                sh "cp ${LOG_DIR}/unittest-${env.TIMESTAMP}.log ."

                // 5. Archive the timestamped log as an artifact
                archiveArtifacts artifacts: "unittest-${env.TIMESTAMP}.log", fingerprint: true
            }
        }
    }
}
